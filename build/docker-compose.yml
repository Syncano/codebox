version: '3'

services:
  broker:
    command: codebox --debug broker
    image: syncano/codebox
    build: .
    depends_on:
      - lb
    ports:
      - "9000:9000"
      - "8080:8080"
    environment:
      - LB_ADDRS=lb:9000
      - SERVICE_NAME=codebox-broker
      - BROKER_URL=
      - ZIPKIN_ADDR
      - REDIS_ADDR

  lb:
    command: codebox --debug lb
    image: syncano/codebox
    build: .
    ports:
      - "9001:9000"
    environment:
      - SERVICE_NAME=codebox-lb
      - ZIPKIN_ADDR

  worker:
    command: codebox --debug worker
    user: root
    image: syncano/codebox
    privileged: true
    build: .
    depends_on:
      - lb
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /tmp/storage:/home/codebox/storage
    environment:
      - HOST_STORAGE_PATH=/tmp/storage
      - LB_ADDR=lb:9000
      - SERVICE_NAME=codebox-worker
      - ZIPKIN_ADDR
